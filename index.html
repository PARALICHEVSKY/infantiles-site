import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.util.*;

/**
 * MeowSim - simple virtual cat simulator in a single Java file.
 * Features:
 * - Feed the cat, play with it, put to sleep
 * - Buy toys from a shop (coins)
 * - Cat stats: hunger, happiness, energy, coins
 * - Time tick via Swing Timer that updates stats
 * - Simple drawn cat & toy icons
 * - Save/load state to a local file (meowsim.save)
 *
 * Compile: javac MeowSim.java
 * Run:     java MeowSim
 * Requires Java 8+
 */
public class MeowSim extends JFrame {
    // Game state
    private Cat cat;
    private java.util.List<Toy> toysForSale;

    // UI
    private GamePanel gamePanel;
    private JLabel hungerLabel, happyLabel, energyLabel, coinsLabel;
    private JButton feedBtn, playBtn, sleepBtn, shopBtn, saveBtn, loadBtn;

    // Timer for ticks (1 second ticks)
    private Timer tickTimer;

    public MeowSim() {
        super("MeowSim — Мяусим");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(800, 520);
        setLocationRelativeTo(null);

        initGame();
        initUI();
        initTimer();
    }

    private void initGame() {
        cat = new Cat("Мурзик");
        toysForSale = new ArrayList<>();
        toysForSale.add(new Toy("Мячик", 10, 18));
        toysForSale.add(new Toy("Пёрышко", 20, 30));
        toysForSale.add(new Toy("Лазер", 50, 60));
    }

    private void initUI() {
        JPanel root = new JPanel(new BorderLayout());

        gamePanel = new GamePanel();
        gamePanel.setPreferredSize(new Dimension(520, 480));
        root.add(gamePanel, BorderLayout.CENTER);

        JPanel right = new JPanel();
        right.setPreferredSize(new Dimension(260, 480));
        right.setLayout(new BoxLayout(right, BoxLayout.Y_AXIS));
        right.setBorder(BorderFactory.createEmptyBorder(10,10,10,10));

        hungerLabel = new JLabel();
        happyLabel = new JLabel();
        energyLabel = new JLabel();
        coinsLabel = new JLabel();
        updateLabels();

        feedBtn = new JButton("Покормить (5 монет)");
        playBtn = new JButton("Поиграть");
        sleepBtn = new JButton("Уложить спать");
        shopBtn = new JButton("Магазин игрушек");
        saveBtn = new JButton("Сохранить");
        loadBtn = new JButton("Загрузить");

        feedBtn.setAlignmentX(Component.CENTER_ALIGNMENT);
        playBtn.setAlignmentX(Component.CENTER_ALIGNMENT);
        sleepBtn.setAlignmentX(Component.CENTER_ALIGNMENT);
        shopBtn.setAlignmentX(Component.CENTER_ALIGNMENT);
        saveBtn.setAlignmentX(Component.CENTER_ALIGNMENT);
        loadBtn.setAlignmentX(Component.CENTER_ALIGNMENT);

        right.add(hungerLabel);
        right.add(Box.createRigidArea(new Dimension(0,6)));
        right.add(happyLabel);
        right.add(Box.createRigidArea(new Dimension(0,6)));
        right.add(energyLabel);
        right.add(Box.createRigidArea(new Dimension(0,6)));
        right.add(coinsLabel);
        right.add(Box.createVerticalGlue());

        right.add(feedBtn);
        right.add(Box.createRigidArea(new Dimension(0,6)));
        right.add(playBtn);
        right.add(Box.createRigidArea(new Dimension(0,6)));
        right.add(sleepBtn);
        right.add(Box.createRigidArea(new Dimension(0,6)));
        right.add(shopBtn);
        right.add(Box.createRigidArea(new Dimension(0,6)));
        right.add(saveBtn);
        right.add(Box.createRigidArea(new Dimension(0,6)));
        right.add(loadBtn);

        root.add(right, BorderLayout.EAST);

        setContentPane(root);

        // Actions
        feedBtn.addActionListener(e -> {
            if (cat.coins >= 5) {
                cat.coins -= 5;
                cat.feed(30);
                appendMessage("Ты покормил " + cat.name + " — +30 голода.");
            } else {
                appendMessage("Недостаточно монет, чтобы покормить.");
            }
            updateLabels();
            gamePanel.repaint();
        });

        playBtn.addActionListener(e -> {
            if (cat.energy < 15) {
                appendMessage(cat.name + " слишком устал играть.");
            } else if (cat.toys.isEmpty()) {
                appendMessage("У тебя нет игрушек. Купи в магазине.");
            } else {
                // choose a toy randomly from inventory
                Toy t = cat.toys.get(new Random().nextInt(cat.toys.size()));
                int gain = t.playValue;
                cat.play(gain);
                cat.energy -= 10;
                appendMessage("Вы поиграли с " + cat.name + " и игрушкой '" + t.name + "' — +" + gain + " настроения.");
            }
            updateLabels();
            gamePanel.repaint();
        });

        sleepBtn.addActionListener(e -> {
            cat.sleep();
            appendMessage(cat.name + " поспал и восстановил энергию.");
            updateLabels();
            gamePanel.repaint();
        });

        shopBtn.addActionListener(e -> openShop());

        saveBtn.addActionListener(e -> {
            try {
                saveGame();
                appendMessage("Игра сохранена.");
            } catch (Exception ex) {
                appendMessage("Ошибка при сохранении: " + ex.getMessage());
            }
        });

        loadBtn.addActionListener(e -> {
            try {
                loadGame();
                appendMessage("Игра загружена.");
                updateLabels();
                gamePanel.repaint();
            } catch (Exception ex) {
                appendMessage("Ошибка при загрузке: " + ex.getMessage());
            }
        });

        // Mouse interaction: click cat to pet
        gamePanel.addMouseListener(new MouseAdapter() {
            public void mouseClicked(MouseEvent e) {
                if (gamePanel.isClickOnCat(e.getX(), e.getY())) {
                    cat.pet();
                    appendMessage("Ты погладил " + cat.name + ". Настроение +5.");
                    updateLabels();
                    gamePanel.repaint();
                }
            }
        });
    }

    private void initTimer() {
        tickTimer = new Timer(1000, e -> {
            cat.tick();
            // occasional coin reward
            if (new Random().nextInt(30) == 0) {
                int bonus = 1 + new Random().nextInt(3);
                cat.coins += bonus;
                appendMessage("Ты нашёл " + bonus + " монетки!");
            }
            updateLabels();
            gamePanel.repaint();
        });
        tickTimer.start();
    }

    private void openShop() {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < toysForSale.size(); i++) {
            Toy t = toysForSale.get(i);
            sb.append(i + 1).append(". ").append(t.name).append(" — ").append(t.price).append(" монет (игра +").append(t.playValue).append(")\n");
        }
        sb.append("\nУ тебя монет: ").append(cat.coins).append(". Введи номер игрушки чтобы купить, или Отмена.");

        String s = JOptionPane.showInputDialog(this, sb.toString(), "Магазин игрушек", JOptionPane.PLAIN_MESSAGE);
        if (s == null) return;
        try {
            int idx = Integer.parseInt(s.trim()) - 1;
            if (idx < 0 || idx >= toysForSale.size()) {
                appendMessage("Неверный выбор.");
                return;
            }
            Toy chosen = toysForSale.get(idx);
            if (cat.coins >= chosen.price) {
                cat.coins -= chosen.price;
                cat.toys.add(chosen.clone());
                appendMessage("Вы купили '" + chosen.name + "'.");
                updateLabels();
            } else {
                appendMessage("Недостаточно монет для покупки.");
            }
        } catch (NumberFormatException ex) {
            appendMessage("Покупка отменена или ввели не число.");
        }
    }

    private void updateLabels() {
        hungerLabel.setText("Голод: " + cat.hunger + " / 100");
        happyLabel.setText("Настроение: " + cat.happiness + " / 100");
        energyLabel.setText("Энергия: " + cat.energy + " / 100");
        coinsLabel.setText("Монеты: " + cat.coins + "  |  Игрушек: " + cat.toys.size());
    }

    private void appendMessage(String msg) {
        gamePanel.addMessage(msg);
    }

    private void saveGame() throws Exception {
        try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("meowsim.save"))) {
            oos.writeObject(cat);
            // also save inventory toys available (not necessary but simple)
        }
    }

    private void loadGame() throws Exception {
        try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream("meowsim.save"))) {
            Cat loaded = (Cat) ois.readObject();
            this.cat = loaded;
            // ensure UI references updated
        }
        // reassign in UI
        updateLabels();
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            MeowSim sim = new MeowSim();
            sim.setVisible(true);
        });
    }

    // --- Inner classes ---
    static class Cat implements Serializable {
        String name;
        int hunger;     // 0..100 (100 = full)
        int happiness;  // 0..100
        int energy;     // 0..100
        int coins;
        transient java.util.List<String> recentMessages;
        java.util.List<Toy> toys;

        Cat(String name) {
            this.name = name;
            this.hunger = 70;
            this.happiness = 80;
            this.energy = 80;
            this.coins = 20;
            this.toys = new ArrayList<>();
            this.recentMessages = new LinkedList<>();
        }

        private void readObject(ObjectInputStream in) throws Exception {
            in.defaultReadObject();
            recentMessages = new LinkedList<>();
            if (toys == null) toys = new ArrayList<>();
        }

        void feed(int amount) {
            hunger = Math.min(100, hunger + amount);
            happiness = Math.min(100, happiness + amount/6);
        }

        void play(int amount) {
            happiness = Math.min(100, happiness + amount);
            hunger = Math.max(0, hunger - amount/5);
        }

        void pet() {
            happiness = Math.min(100, happiness + 5);
        }

        void sleep() {
            energy = Math.min(100, energy + 40);
            hunger = Math.max(0, hunger - 15);
        }

        void tick() {
            // every tick: hunger down slightly, energy down slightly
            hunger = Math.max(0, hunger - 1);
            energy = Math.max(0, energy - 1);
            // if hunger low, happiness falls
            if (hunger < 20) happiness = Math.max(0, happiness - 2);
            // if energy low, happiness falls
            if (energy < 15) happiness = Math.max(0, happiness - 1);
            // gain tiny passive coins if happy
            if (happiness > 80 && new Random().nextInt(50) == 0) coins += 1;
        }
    }

    static class Toy implements Serializable, Cloneable {
        String name;
        int price;
        int playValue;

        Toy(String n, int p, int v) { name = n; price = p; playValue = v; }

        public Toy clone() {
            return new Toy(name, price, playValue);
        }
    }

    // Simple game panel: draws cat, toys, and message area
    class GamePanel extends JPanel {
        private java.util.List<String> messages = new LinkedList<>();

        GamePanel() {
            setBackground(new Color(245, 245, 250));
            messages.add("Добро пожаловать в MeowSim! Кликни по коту чтобы погладить.");
        }

        void addMessage(String m) {
            messages.add(0, m);
            if (messages.size() > 6) messages = messages.subList(0, 6);
            repaint();
        }

        boolean isClickOnCat(int x, int y) {
            // cat drawn at center-left area
            int cx = 200; int cy = 180; int r = 110;
            int dx = x - cx, dy = y - cy;
            return dx*dx + dy*dy <= r*r;
        }

        protected void paintComponent(Graphics g) {
            super.paintComponent(g);
            Graphics2D g2 = (Graphics2D) g;
            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

            // draw background floor
            g2.setColor(new Color(230, 230, 235));
            g2.fillRect(0, 360, getWidth(), getHeight()-360);

            // draw cat (simple stylized)
            int cx = 200, cy = 180, r = 110;
            // body
            g2.setColor(new Color(200, 170, 160));
            g2.fillOval(cx - r, cy - r, r*2, r*2);
            // face
            g2.setColor(new Color(220, 200, 190));
            g2.fillOval(cx - 60, cy - 70, 120, 120);
            // eyes
            g2.setColor(Color.white);
            g2.fillOval(cx - 30, cy - 30, 28, 18);
            g2.fillOval(cx + 2, cy - 30, 28, 18);
            g2.setColor(Color.black);
            g2.fillOval(cx - 22, cy - 26, 8, 8);
            g2.fillOval(cx + 10, cy - 26, 8, 8);
            // nose
            g2.setColor(new Color(180, 100, 120));
            Polygon nose = new Polygon(new int[]{cx, cx-6, cx+6}, new int[]{cy - 8, cy + 6, cy + 6}, 3);
            g2.fillPolygon(nose);
            // mouth
            g2.drawArc(cx - 14, cy + 6, 12, 8, 200, 140);
            g2.drawArc(cx + 2, cy + 6, 12, 8, -20, 140);
            // ears
            g2.setColor(new Color(200, 170, 160));
            g2.fillPolygon(new int[]{cx-60, cx-40, cx-20}, new int[]{cy-60, cy-110, cy-60}, 3);
            g2.fillPolygon(new int[]{cx+60, cx+40, cx+20}, new int[]{cy-60, cy-110, cy-60}, 3);

            // draw toys from inventory near right side
            int tx = 420, ty = 120;
            g2.setColor(new Color(240, 230, 200));
            g2.fillRoundRect(380, 40, 340, 240, 18, 18);
            g2.setColor(Color.BLACK);
            g2.drawString("Инвентарь (кликать кнопкой Поиграть чтобы использовать игрушку)", 390, 60);
            int i = 0;
            for (Toy t : cat.toys) {
                int ix = tx + (i%2)*120;
                int iy = ty + (i/2)*70;
                drawToyIcon(g2, t, ix, iy);
                i++; if (i>5) break;
            }

            // draw messages
            g2.setColor(Color.BLACK);
            g2.drawString("События:", 20, 420);
            int my = 436;
            for (String m : messages) {
                g2.drawString(m, 20, my);
                my += 16;
            }

            // draw stat bars
            drawStatBar(g2, 20, 20, "Голод", cat.hunger);
            drawStatBar(g2, 20, 50, "Настроение", cat.happiness);
            drawStatBar(g2, 20, 80, "Энергия", cat.energy);
        }

        private void drawToyIcon(Graphics2D g2, Toy t, int x, int y) {
            g2.setColor(new Color(210, 190, 230));
            g2.fillOval(x, y, 48, 48);
            g2.setColor(Color.black);
            g2.drawOval(x, y, 48, 48);
            g2.drawString(t.name, x+56, y+28);
        }

        private void drawStatBar(Graphics2D g2, int x, int y, String label, int value) {
            g2.drawString(label + ": " + value + "/100", x, y+12);
            g2.setColor(new Color(200,200,200));
            g2.fillRect(x+100, y, 160, 12);
            g2.setColor(new Color(150,200,150));
            g2.fillRect(x+100, y, (int)(1.6*value), 12);
            g2.setColor(Color.BLACK);
            g2.drawRect(x+100, y, 160, 12);
        }
    }
}
